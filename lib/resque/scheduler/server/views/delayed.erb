<%- size = resque.delayed_queue_schedule_size %>

<%=
  scheduler_view(
    :header_info,
    { layout: false },
    title: 'Delayed Jobs',
    intro: 'This list below contains the timestamps for scheduled delayed jobs.'
  )
%>

<%= scheduler_view :search_form, layout: false %>

<% unless (@error_message || '').empty? %>
  <p style="font-color: red; font-weight: bold;"><%= @error_message %></p>
<% end %>

<p class="sub">
  Showing <%= start = params[:start].to_i %> to <%= [start + per_page, size].min %> of
  <b><%= size %></b> timestamps
</p>

<% unless size.zero? %>
  <div style="overflow-y: auto; width: 100%">
    <table class="jobs">
      <thead>
      <tr>
        <th></th>
        <th>Timestamp</th>
        <th>Job count</th>
        <th>Class</th>
        <th>Args</th>
        <th>All schedules</th>
      </tr>
      </thead>
      <tbody>
      <% resque.delayed_queue_peek(start, per_page).each do |timestamp| %>
        <tr>
          <td>
            <form action="<%= u '/delayed/queue_now' %>" method="post" style="margin: 0">
              <input type="hidden" name="timestamp" value="<%= timestamp.to_i %>">
              <input type="submit" value="Queue Now">
            </form>
          </td>
          <td><a href="<%= u "delayed/#{timestamp}" %>"><%= format_time(Time.at(timestamp)) %></a></td>
          <td><%= delayed_timestamp_size = resque.delayed_timestamp_size(timestamp) %></td>
          <% job = resque.delayed_timestamp_peek(timestamp, 0, 1).first %>
          <td>
            <% if job && delayed_timestamp_size == 1 %>
              <%= h(job['class']) %>
            <% else %>
              <a href="<%= u "delayed/#{timestamp}" %>">see details</a>
            <% end %>
          </td>
          <td><%= h(show_job_arguments(job['args'])) if job && delayed_timestamp_size == 1 %></td>
          <td>
            <% if job %>
              <a href="<%= u URI("/delayed/jobs/#{job['class']}?args=" + URI.encode(job['args'].to_json)) %>">All schedules</a>
            <% end %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>

  <br>
  <form method="post" action="<%= u 'delayed/clear' %>" class="clear-delayed">
    <input type="submit" name="" value="Clear Delayed Jobs" />
  </form>

  <%= partial :next_more, start: start, size: size %>
<% end %>
